{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "watch",
      "dependsOn": [
        "npm: watch:tsc",
        "npm: watch:esbuild"
      ],
      "presentation": {
        "reveal": "never"
      },
      "group": {
        "kind": "build",
        "isDefault": true
      }
    },
    {
      "type": "npm",
      "script": "watch:esbuild",
      "group": "build",
      "isBackground": true,
      "label": "npm: watch:esbuild",
      "presentation": {
        "group": "watch",
        "reveal": "never"
      },
      "problemMatcher": {
        "owner": "esbuild",
        "fileLocation": "absolute",
        "background": {
          "activeOnStart": true,
          "beginsPattern": "\\[watch\\] build started",
          "endsPattern": "\\[watch\\] build finished"
        },
        "pattern": [
          {
            "regexp": "^✘ \\[ERROR\\] (.*)$",
            "message": 1
          },
          {
            "regexp": "^\\s+(.+):(\\d+):(\\d+):$",
            "file": 1,
            "line": 2,
            "column": 3
          }
        ]
      }
    },
    {
      "type": "npm",
      "script": "watch:tsc",
      "group": "build",
      "problemMatcher": "$tsc-watch",
      "isBackground": true,
      "label": "npm: watch:tsc",
      "presentation": {
        "group": "watch",
        "reveal": "never"
      }
    },
    {
      "label": "npm: build",
      "type": "npm",
      "script": "build",
      "problemMatcher": "$tsc"
    },
    {
      "label": "npm: watch",
      "type": "npm",
      "script": "watch",
      "isBackground": true,
      "problemMatcher": "$tsc-watch"
    },
    /* -------------------- ONE-CLICK CHOOSER -------------------- */
    {
      "label": "Test: Run (choose framework/auth/scope)",
      "type": "shell",
      "command": "node",
      "args": [
        "${workspaceFolder}/scripts/test-runner.js"
      ],
      "options": {
        "env": {
          "FRAMEWORK": "${input:FRAMEWORK}",
          "SCOPE": "${input:SCOPE}",
          "AUTH_CHOICE": "${input:AUTH_CHOICE}",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}",
          "COGNITO_CLIENT_ID": "${input:COGNITO_CLIENT_ID}",
          "COGNITO_USERNAME": "${input:COGNITO_USERNAME}",
          "COGNITO_PASSWORD": "${input:COGNITO_PASSWORD}",
          "CONTEXTS_ROOT": "${input:CONTEXTS_ROOT}",
          "PYTHON_BIN": "${config:python.defaultInterpreterPath}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    /* -------------------- JEST (workspace) -------------------- */
    {
      "label": "Test: Jest (API Key, workspace)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}",
          "TESTS_ROOT": "${workspaceFolder}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Jest (IAM, workspace)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "IAM",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}",
          "TESTS_ROOT": "${workspaceFolder}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Jest (Cognito JWT, workspace)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}",
          "TESTS_ROOT": "${workspaceFolder}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Jest (Cognito user/pass, workspace)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "COGNITO_CLIENT_ID": "${input:COGNITO_CLIENT_ID}",
          "COGNITO_USERNAME": "${input:COGNITO_USERNAME}",
          "COGNITO_PASSWORD": "${input:COGNITO_PASSWORD}",
          "AWS_REGION": "${input:AWS_REGION}",
          "TESTS_ROOT": "${workspaceFolder}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    /* -------------------- JEST (external contexts) -------------------- */
    {
      "label": "Test: Jest (API Key, external)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}",
          "TESTS_ROOT": "${input:CONTEXTS_ROOT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Jest (IAM, external)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "IAM",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}",
          "TESTS_ROOT": "${input:CONTEXTS_ROOT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Jest (Cognito JWT, external)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}",
          "TESTS_ROOT": "${input:CONTEXTS_ROOT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Jest (Cognito user/pass, external)",
      "type": "shell",
      "command": "npx",
      "args": [
        "jest",
        "--config",
        "${workspaceFolder}/jest.config.ts",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "COGNITO_CLIENT_ID": "${input:COGNITO_CLIENT_ID}",
          "COGNITO_USERNAME": "${input:COGNITO_USERNAME}",
          "COGNITO_PASSWORD": "${input:COGNITO_PASSWORD}",
          "AWS_REGION": "${input:AWS_REGION}",
          "TESTS_ROOT": "${input:CONTEXTS_ROOT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    /* -------------------- PYTEST (workspace) -------------------- */
    {
      "label": "Test: Pytest (API Key, workspace)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (IAM, workspace)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "IAM",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (Cognito JWT, workspace)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (Cognito user/pass, workspace)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "COGNITO_CLIENT_ID": "${input:COGNITO_CLIENT_ID}",
          "COGNITO_USERNAME": "${input:COGNITO_USERNAME}",
          "COGNITO_PASSWORD": "${input:COGNITO_PASSWORD}",
          "AWS_REGION": "${input:AWS_REGION}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (API Key, workspace) + Allure",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts",
        "--alluredir",
        "${workspaceFolder}/allure-results"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (IAM, workspace) + Allure",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts",
        "--alluredir",
        "${workspaceFolder}/allure-results"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "IAM",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (Cognito JWT, workspace) + Allure",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "contexts",
        "--alluredir",
        "${workspaceFolder}/allure-results"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Allure: Serve (workspace results)",
      "type": "shell",
      "command": "npx",
      "args": [
        "allure",
        "serve",
        "${workspaceFolder}/allure-results"
      ],
      "problemMatcher": []
    },
    {
      "label": "Allure: Generate static report (workspace)",
      "type": "shell",
      "command": "npx",
      "args": [
        "allure",
        "generate",
        "${workspaceFolder}/allure-results",
        "--clean",
        "-o",
        "${workspaceFolder}/allure-report"
      ],
      "problemMatcher": []
    },
    {
      "label": "Allure: Open static report (workspace)",
      "type": "shell",
      "command": "npx",
      "args": [
        "allure",
        "open",
        "${workspaceFolder}/allure-report"
      ],
      "problemMatcher": []
    },
    /* -------------------- PYTEST (external contexts) -------------------- */
    {
      "label": "Test: Pytest (API Key, external)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (IAM, external)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "IAM",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (Cognito JWT, external)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (Cognito user/pass, external)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "COGNITO_CLIENT_ID": "${input:COGNITO_CLIENT_ID}",
          "COGNITO_USERNAME": "${input:COGNITO_USERNAME}",
          "COGNITO_PASSWORD": "${input:COGNITO_PASSWORD}",
          "AWS_REGION": "${input:AWS_REGION}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (API Key, external) + Allure",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts",
        "--alluredir",
        "${input:CONTEXTS_ROOT}/allure-results"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (IAM, external) + Allure",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts",
        "--alluredir",
        "${input:CONTEXTS_ROOT}/allure-results"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "IAM",
          "AWS_REGION": "${input:AWS_REGION}",
          "AWS_PROFILE": "${input:AWS_PROFILE}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Test: Pytest (Cognito JWT, external) + Allure",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${input:CONTEXTS_ROOT}/contexts",
        "--alluredir",
        "${input:CONTEXTS_ROOT}/allure-results"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${input:CONTEXTS_ROOT}/contexts/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "COGNITO",
          "APPSYNC_JWT": "${input:APPSYNC_JWT}"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    /* Allure (external) */
    {
      "label": "Allure: Serve (external results)",
      "type": "shell",
      "command": "npx",
      "args": [
        "allure",
        "serve",
        "${input:CONTEXTS_ROOT}/allure-results"
      ],
      "problemMatcher": []
    },
    {
      "label": "Allure: Generate static report (external)",
      "type": "shell",
      "command": "npx",
      "args": [
        "allure",
        "generate",
        "${input:CONTEXTS_ROOT}/allure-results",
        "--clean",
        "-o",
        "${input:CONTEXTS_ROOT}/allure-report"
      ],
      "problemMatcher": []
    },
    {
      "label": "Allure: Open static report (external)",
      "type": "shell",
      "command": "npx",
      "args": [
        "allure",
        "open",
        "${input:CONTEXTS_ROOT}/allure-report"
      ],
      "problemMatcher": []
    },
    /* -------------------- PYTEST (testsRoot via config) -------------------- */
    {
      "label": "Test: Pytest (API Key, testsRoot)",
      "type": "process",
      "command": "${config:python.defaultInterpreterPath}",
      "args": [
        "-m",
        "pytest",
        "${workspaceFolder}/${config:appsyncTestGen.tests.outputRoot}"
      ],
      "options": {
        "env": {
          "PYTHONPATH": "${workspaceFolder}/${config:appsyncTestGen.tests.outputRoot}/_shared/pytest",
          "APPSYNC_ENDPOINT": "${input:APPSYNC_ENDPOINT}",
          "APPSYNC_AUTH_MODE": "API_KEY",
          "APPSYNC_API_KEY": "${input:APPSYNC_API_KEY}",
          "APPSYNC_WRITE_ARTIFACTS": "onfail",
          "APPSYNC_ARTIFACT_DIR": "artifacts",
          "APPSYNC_EXEC_VIEW": "1"
        }
      },
      "group": "test",
      "problemMatcher": []
    },
    {
      "label": "Clean: build artifacts",
      "type": "shell",
      "command": "npm",
      "args": [
        "run",
        "clean:build"
      ],
      "problemMatcher": []
    },
    {
      "label": "Clean: all (build + reports + caches)",
      "type": "shell",
      "command": "npm",
      "args": [
        "run",
        "clean"
      ],
      "problemMatcher": []
    },
    {
      "label": "Clean: everything (incl node_modules)",
      "type": "shell",
      "command": "npm",
      "args": [
        "run",
        "clean:modules"
      ],
      "problemMatcher": []
    }
  ],
  "inputs": [
    {
      "id": "FRAMEWORK",
      "type": "pickString",
      "description": "Choose test framework",
      "options": [
        "jest",
        "pytest"
      ],
      "default": "jest"
    },
    {
      "id": "SCOPE",
      "type": "pickString",
      "description": "Where are the contexts?",
      "options": [
        "workspace",
        "external"
      ],
      "default": "workspace"
    },
    {
      "id": "AUTH_CHOICE",
      "type": "pickString",
      "description": "Auth mode",
      "options": [
        "API_KEY",
        "IAM",
        "COGNITO_JWT",
        "COGNITO_UP"
      ],
      "default": "API_KEY"
    },
    {
      "id": "APPSYNC_ENDPOINT",
      "type": "promptString",
      "description": "GraphQL endpoint (https://…appsync-api.<region>.amazonaws.com/graphql)"
    },
    {
      "id": "APPSYNC_API_KEY",
      "type": "promptString",
      "description": "AppSync API Key (API_KEY auth)",
      "password": true
    },
    {
      "id": "AWS_REGION",
      "type": "promptString",
      "description": "AWS region (IAM / Cognito username/password)",
      "default": "us-east-1"
    },
    {
      "id": "AWS_PROFILE",
      "type": "promptString",
      "description": "AWS CLI profile (optional, IAM)",
      "default": ""
    },
    {
      "id": "APPSYNC_JWT",
      "type": "promptString",
      "description": "Cognito ID token (JWT) for COGNITO_JWT",
      "password": true
    },
    {
      "id": "COGNITO_CLIENT_ID",
      "type": "promptString",
      "description": "Cognito App Client ID (COGNITO_UP)"
    },
    {
      "id": "COGNITO_USERNAME",
      "type": "promptString",
      "description": "Cognito username (COGNITO_UP)"
    },
    {
      "id": "COGNITO_PASSWORD",
      "type": "promptString",
      "description": "Cognito password (COGNITO_UP)",
      "password": true
    },
    {
      "id": "CONTEXTS_ROOT",
      "type": "promptString",
      "description": "Absolute path that contains 'contexts/' (for external scope)",
      "default": ""
    }
  ]
}